name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Run clang-format
      run: |
        pipx install clang-format
        clang-format --version
        clang-format --Werror --dry-run local_mw.cpp

    - name: Run make
      run: make

    - name: Binary check (./bin/local_mw --version)
      run: ./bin/local_mw --version

    - name: Binary check (./bin/local_mw --fox)
      run: ./bin/local_mw --fox

    - name: Binary check (./bin/local_mw --not-known-flag)
      run: ./bin/local_mw --not-known-flag || echo "Expected failure on unknown flag"

    - name: Verify version in output
      run: |
        VERSION=$(git describe --tags 2>/dev/null || echo "dev-unknown")
        echo "Expected version: $VERSION"
        VERSION_OUTPUT=$(./bin/local_mw --version 2>&1)
        if echo "$VERSION_OUTPUT" | grep -q "Version: $VERSION"; then
          echo "Version check passed: Version $VERSION found in version output"
        else
          echo "Version check failed: Version $VERSION not found in version output"
          echo "Version output:"
          echo "$VERSION_OUTPUT"
          exit 1
        fi
